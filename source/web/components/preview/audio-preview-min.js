(function(){var d=YAHOO.util.Dom,g=YAHOO.util.Event,a=YAHOO.util.Element;Alfresco.AudioPreview=function(l){Alfresco.AudioPreview.superclass.constructor.call(this,"Alfresco.AudioPreview",l,["button","container","datatable","datasource","uploader"]);YAHOO.Bubbling.on("documentDetailsAvailable",this.onDocumentDetailsAvailable,this);YAHOO.Bubbling.on("recalculatePreviewLayout",this.onRecalculatePreviewLayout,this);return this};YAHOO.extend(Alfresco.AudioPreview,Alfresco.component.Base,{options:{nodeRef:"",size:"0",name:"",icon:"",mimeType:"",previews:[],availablePreviews:[]},onComponentsLoaded:function j(){YAHOO.deconcept.SWFObject.prototype.getVariablePairs=function(){var l=[],m,n=this.getVariables();for(m in n){if(n.hasOwnProperty(m)){l[l.length]=m+"="+encodeURIComponent(n[m])}}return l};g.onContentReady(this.id,this.onReady,this,true)},onReady:function h(){this._setupAudioPreview(false)},onDocumentDetailsAvailable:function b(n,l){var o=l[1].documentDetails,m=false;if(this.options.name!=o.fileName){this.options.name=o.fileName;m=true}if(this.options.mimeType!=o.mimetype){this.options.mimeType=o.mimetype;m=true}if(this.options.size!=o.size){this.options.size=o.size;m=true}if(m){this._setupAudioPreview()}},onRecalculatePreviewLayout:function k(m,l){if(this.widgets.realSwfDivEl.getStyle("height")!=="100%"){this._positionOver(this.widgets.realSwfDivEl,this.widgets.shadowSfwDivEl)}},_setupAudioPreview:function f(){this.widgets.swfPlayerMessage=d.get(this.id+"-swfPlayerMessage-div");this.widgets.titleText=d.get(this.id+"-title-span");this.widgets.titleImg=d.get(this.id+"-title-img");this.widgets.titleText.innerHTML=this.options.name;this.widgets.titleImg.src=Alfresco.constants.URL_CONTEXT+this.options.icon.substring(1);if(this.options.nodeRef===undefined){throw new Error("A nodeRef must be provided")}if(!this.widgets.realSwfDivEl){var o=new a(document.createElement("div"));o.set("id",this.id+"-real-swf-div");o.setStyle("position","absolute");o.addClass("web-preview");o.addClass("real");o.appendTo(document.body);this.widgets.realSwfDivEl=o}this.widgets.shadowSfwDivEl=new a(this.id+"-shadow-swf-div");if(this.options.size=="0"){this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noContent")}else{if(Alfresco.util.hasRequiredFlashPlayer(9,0,45)){var l=this._resolvePreview();if(l){if(l.audiourl){this.widgets.shadowSfwDivEl.addClass("has-content");this.widgets.realSwfDivEl.removeClass("no-content");var n="AudioPreviewer_"+this.id;var p=new YAHOO.deconcept.SWFObject(Alfresco.constants.URL_CONTEXT+"components/preview/player_mp3_maxi.swf",n,"100%","100%","9.0.45");p.addVariable("fileName",this.options.name);p.addVariable("mp3",l.audiourl);p.addVariable("title",this.msg("preview.preparingAudio"));p.addVariable("showvolume",1);p.addVariable("bgcolor1","e1e3e5");p.addVariable("bgcolor2","999999");p.addVariable("slidercolor1","999999");p.addVariable("slidercolor2","666666");p.addVariable("buttoncolor","333333");p.addVariable("buttonovercolor","0088de");p.addVariable("sliderovercolor","0088de");p.addParam("allowScriptAccess","sameDomain");p.addParam("allowFullScreen","true");p.addParam("quality","autohigh");p.addParam("wmode","transparent");this.widgets.swfPlayerMessage.innerHTML="";p.write(this.widgets.realSwfDivEl.get("id"));this.widgets.swfObject=p;g.addListener(n,"mouseover",function(r){var q=d.get(n);if(q&&YAHOO.lang.isFunction(q.setMode)){d.get(n).setMode("active")}});g.addListener(n,"mouseout",function(r){var q=d.get(n);if(q&&YAHOO.lang.isFunction(q.setMode)){d.get(n).setMode("inactive")}});g.addListener(window,"resize",function(q){YAHOO.Bubbling.fire("recalculatePreviewLayout")})}else{this._queueAudioThumbnailGeneration();this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");var m=Alfresco.constants.PROXY_URI+"api/node/content/"+this.options.nodeRef.replace(":/","")+"/"+encodeURIComponent(this.options.name)+"?a=true";this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noAudioAvailable",m)}}else{this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");var m=Alfresco.constants.PROXY_URI+"api/node/content/"+this.options.nodeRef.replace(":/","")+"/"+encodeURIComponent(this.options.name)+"?a=true";this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noPreview",m)}}else{this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noFlash")}}this._positionOver(this.widgets.realSwfDivEl,this.widgets.shadowSfwDivEl)},_resolvePreview:function c(m){var l=this.options.previews,r,n=this.options.availablePreviews,p="flvpreview",o="h264preview",s="imgpreviewfull",v=this.options.nodeRef.replace(":/",""),q="?c=force&noCacheToken="+new Date().getTime(),t,u;u=Alfresco.constants.PROXY_URI+"api/node/"+v+"/content/thumbnails/"+s+q;if(this.options.mimeType.match(/^audio\/x-mpeg$/)){t=Alfresco.constants.PROXY_URI+"api/node/"+v+"/content"+q;return({audiourl:t,imageurl:u})}else{r=Alfresco.util.arrayContains(l,o)?o:(Alfresco.util.arrayContains(l,p)?p:null);audiopreviewavail=Alfresco.util.arrayContains(n,o)?o:(Alfresco.util.arrayContains(n,p)?p:null);if(r!==null){if(audiopreviewavail!==null){t=Alfresco.constants.PROXY_URI+"api/node/"+v+"/content/thumbnails/"+audiopreviewavail+q}return({audiourl:t,imageurl:u})}else{return null}}},_queueAudioThumbnailGeneration:function i(){var q=this.options.previews,p,m="mp3preview";p=Alfresco.util.arrayContains(q,m)?m:null;if(p!==null){var n=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/node/{nodeRef}/content/thumbnails/{thumbnailname}?c=queue",{nodeRef:this.options.nodeRef.replace(":/",""),thumbnailname:p});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:n,successCallback:{fn:function l(r,s){},scope:this,obj:{}},failureCallback:{fn:function o(r,s){},scope:this,obj:{}}})}},_positionOver:function e(m,l){var n=d.getRegion(l.get("id"));m.setStyle("left",n.left+"px");m.setStyle("top",n.top+"px");m.setStyle("width",n.width+"px");m.setStyle("height",n.height+"px")}})})();