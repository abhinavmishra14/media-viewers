(function(){var e=YAHOO.util.Dom,i=YAHOO.util.Event,b=YAHOO.util.Element;Alfresco.VideoPreview=function(m){Alfresco.VideoPreview.superclass.constructor.call(this,"Alfresco.VideoPreview",m,["button","container","datatable","datasource","uploader"]);YAHOO.Bubbling.on("documentDetailsAvailable",this.onDocumentDetailsAvailable,this);YAHOO.Bubbling.on("recalculatePreviewLayout",this.onRecalculatePreviewLayout,this);return this};YAHOO.extend(Alfresco.VideoPreview,Alfresco.component.Base,{options:{nodeRef:"",size:"0",name:"",icon:"",mimeType:"",previews:[],availablePreviews:[]},onComponentsLoaded:function k(){YAHOO.deconcept.SWFObject.prototype.getVariablePairs=function(){var m=[],n,o=this.getVariables();for(n in o){if(o.hasOwnProperty(n)){m[m.length]=n+"="+encodeURIComponent(o[n])}}return m};i.onContentReady(this.id,this.onReady,this,true)},onReady:function j(){this._setupVideoPreview(false)},onDocumentDetailsAvailable:function c(o,m){var p=m[1].documentDetails,n=false;if(this.options.name!=p.fileName){this.options.name=p.fileName;n=true}if(this.options.mimeType!=p.mimetype){this.options.mimeType=p.mimetype;n=true}if(this.options.size!=p.size){this.options.size=p.size;n=true}if(n){this._setupVideoPreview()}},onRecalculatePreviewLayout:function l(n,m){if(this.widgets.realSwfDivEl.getStyle("height")!=="100%"){this._positionOver(this.widgets.realSwfDivEl,this.widgets.shadowSfwDivEl)}},_setupVideoPreview:function f(){this.widgets.swfPlayerMessage=e.get(this.id+"-swfPlayerMessage-div");this.widgets.titleText=e.get(this.id+"-title-span");this.widgets.titleImg=e.get(this.id+"-title-img");this.widgets.titleText.innerHTML=this.options.name;this.widgets.titleImg.src=Alfresco.constants.URL_CONTEXT+this.options.icon.substring(1);if(this.options.nodeRef===undefined){throw new Error("A nodeRef must be provided")}if(!this.widgets.realSwfDivEl){var p=new b(document.createElement("div"));p.set("id",this.id+"-real-swf-div");p.setStyle("position","absolute");p.addClass("web-preview");p.addClass("real");p.appendTo(document.body);this.widgets.realSwfDivEl=p}this.widgets.shadowSfwDivEl=new b(this.id+"-shadow-swf-div");if(this.options.size=="0"){this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noContent")}else{if(Alfresco.util.hasRequiredFlashPlayer(6,0,0)){var m=this._resolvePreview();if(m){if(m.videourl){this.widgets.shadowSfwDivEl.addClass("has-content");this.widgets.realSwfDivEl.removeClass("no-content");var o="VideoPreviewer_"+this.id;var q=new YAHOO.deconcept.SWFObject(Alfresco.constants.URL_CONTEXT+"components/preview/player_flv_maxi.swf",o,"100%","100%","6.0.0");q.addVariable("fileName",this.options.name);q.addVariable("flv",m.videourl);q.addVariable("title",this.msg("preview.preparingVideo"));q.addVariable("startimage",m.imageurl);q.addVariable("showfullscreen",1);q.addVariable("showiconplay",1);q.addVariable("showplayer","always");q.addVariable("showvolume",1);q.addVariable("showtime",1);q.addVariable("playercolor","e1e3e5");q.addVariable("margin","0");q.addVariable("buttoncolor","000000");q.addVariable("buttonovercolor","0088de");q.addVariable("sliderovercolor","0088de");q.addParam("allowScriptAccess","sameDomain");q.addParam("allowFullScreen","true");q.addParam("quality","autohigh");q.addParam("wmode","transparent");this.widgets.swfPlayerMessage.innerHTML="";q.write(this.widgets.realSwfDivEl.get("id"));this.widgets.swfObject=q;i.addListener(o,"mouseover",function(s){var r=e.get(o);if(r&&YAHOO.lang.isFunction(r.setMode)){e.get(o).setMode("active")}});i.addListener(o,"mouseout",function(s){var r=e.get(o);if(r&&YAHOO.lang.isFunction(r.setMode)){e.get(o).setMode("inactive")}});i.addListener(window,"resize",function(r){YAHOO.Bubbling.fire("recalculatePreviewLayout")})}else{this._queueVideoThumbnailGeneration();this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");var n=Alfresco.constants.PROXY_URI+"api/node/content/"+this.options.nodeRef.replace(":/","")+"/"+encodeURIComponent(this.options.name)+"?a=true";this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noVideoAvailable",n)}}else{this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");var n=Alfresco.constants.PROXY_URI+"api/node/content/"+this.options.nodeRef.replace(":/","")+"/"+encodeURIComponent(this.options.name)+"?a=true";this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noPreview",n)}}else{this.widgets.shadowSfwDivEl.removeClass("has-content");this.widgets.realSwfDivEl.addClass("no-content");this.widgets.swfPlayerMessage.innerHTML=this.msg("label.noFlash")}}this._positionOver(this.widgets.realSwfDivEl,this.widgets.shadowSfwDivEl)},_getSupportedVideoMimeTypes:function h(){var q=this.options.previews,p="flvpreview",s="h264preview",o="video/x-flv",m="video/mp4",n=this.options.mimeType,r=[];if((Alfresco.util.arrayContains(q,s)||n==m)&&Alfresco.util.hasRequiredFlashPlayer(9,0,115)){r.push(m)}else{if((Alfresco.util.arrayContains(q,p)||n==o)&&Alfresco.util.hasRequiredFlashPlayer(6,0,0)){r.push(o)}}return r},_resolvePreview:function d(n){var m=this.options.previews,t,o=this.options.availablePreviews,q="flvpreview",p="h264preview",s="imgpreviewfull",x=this.options.nodeRef.replace(":/",""),r="?c=force&noCacheToken="+new Date().getTime(),w,v;v=Alfresco.constants.PROXY_URI+"api/node/"+x+"/content/thumbnails/"+s+r;var u=this._getSupportedVideoMimeTypes();if(Alfresco.util.arrayContains(u,this.options.mimeType)){w=Alfresco.constants.PROXY_URI+"api/node/"+x+"/content"+r;return({videourl:w,imageurl:v})}else{t=u.length>0?(u[0]=="video/mp4"?p:(u[0]=="video/x-flv"?q:null)):null;if(t!==null){if(Alfresco.util.arrayContains(o,t)){w=Alfresco.constants.PROXY_URI+"api/node/"+x+"/content/thumbnails/"+t+r}return({videourl:w,imageurl:v})}else{return null}}},_queueVideoThumbnailGeneration:function a(){var r=this.options.previews,m,p="flvpreview",s="h264preview";m=Alfresco.util.arrayContains(r,s)?s:(Alfresco.util.arrayContains(r,p)?p:null);if(m!==null){var o=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/node/{nodeRef}/content/thumbnails/{thumbnailname}?c=queue",{nodeRef:this.options.nodeRef.replace(":/",""),thumbnailname:m});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:o,successCallback:{fn:function n(t,u){},scope:this,obj:{}},failureCallback:{fn:function q(t,u){},scope:this,obj:{}}})}},_positionOver:function g(n,m){var o=e.getRegion(m.get("id"));n.setStyle("left",o.left+"px");n.setStyle("top",o.top+"px");n.setStyle("width",o.width+"px");n.setStyle("height",o.height+"px")}})})();